# Tutorial: Taxonomy mapping using MapMyCells

This tutorial shows how to run the MapMyCells python mapping algorithm against a taxonomy.

## Overview
#### Required inputs:

* Count matrix (cell x gene), with genes as colnames and sample identifiers as rownames.

#### Additional prerequisites:

* Precomputed cell_type_mapper files required for mapping.
* cell_type_mapper library https://github.com/AllenInstitute/cell_type_mapper

## How to map the cells

### Step1: Python environment installation [Link](https://github.com/AllenInstitute/scrattch.mapping/blob/inkar-HANN-python-tutorial/examples/setup_env_MapMyCells.md)

### Step 2: Map your cells

This tutorial uses the 'precompute stats' and 'query markers' files generated by the [scrattch.taxonomy MapMyCells tutorial](https://github.com/AllenInstitute/scrattch.taxonomy/blob/Inkar-cell-type-mapper-tutorial-python/examples/build_taxonomy_mapmycells.md) to run the mapping.

*Note*: conda environment needs to be activated to run the code below. Run `conda activate <your-env-name>` to activate.

```
python -m cell_type_mapper.cli.from_specified_markers \
--query_path <path_to_your_count_matrix.h5ad> \
--type_assignment.normalization raw \
--precomputed_stats.path <path_to_your_taxonomy_files_directory>/siletti_hmba_subsampled_precompute_stats.h5 \
--query_markers.serialized_lookup <path_to_your_taxonomy_files_directory>/siletti_hmba_subsampled_query_markers.json \
--extended_result_path <path_to_your_taxonomy_files_directory>/subsampled_self_proj_hann_results.json \
--type_assignment.n_processors 16 \
--type_assignment.chunk_size 1000
```

*Note*:
* Change the query h5ad_path parameter above to any other h5ad taxonomy file location.
* Pre-defined folder in your own directory where the built taxonomy files are saved, to later be used for mapping, and pass instead of <path_to_your_taxonomy_files_directory>
* Change normalization to either 'log2CPM' or keep as 'raw' based on the count matrix of your taxonomy.
* Change the name of the precompute_stats file (siletti_hmba_subsampled_precompute_stats.h5) if you're using a different taxonomy.
* Change the name of the query_markers file (siletti_hmba_subsampled_query_markers.json) if you're using a different taxonomy.
* Change the name of the results file (subsampled_self_proj_hann_results.json) if you're using a different taxonomy.
* Change the n_processors and chunk_size based on the available CPU and memory.

For more information about other command line parameters, run in your terminal:
```
python -m cell_type_mapper.cli.from_specified_markers --help
```
  
